@using Fao.Front_End.Helpers
@using Fao.Front_End.Models
@using Fao.Front_End.Services
<div class="modal fade" id="achievementModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Ajout d'un progrès</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <EditForm Model="@formData" OnValidSubmit="HandleSubmit">
                <main class="modal-body">
                    <select name="achievementType" id="achievementType" class="form-select form-select-lg fw-semibold"
                        @bind="SelectedType">
                        <option default value="weight">Poids</option>
                        <option value="measurement">Mensuration</option>
                        <option value="photo">Photo</option>
                        <option value="free-comment">Commentaire/ressentit</option>
                    </select>
                    <div class="mt-3">
                        <label for="date" class="fw-semibold">Date du
                            progrès:</label>
                        <InputDate id="date" @bind-Value="formData.DateAchieved" class="form-control" max="@Today"
                            required />
                    </div>
                    <div class="mt-3">
                        @RenderFormFields()
                    </div>

                </main>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-success">Ajouter le
                        progrès</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Inject] private AchievementService AchievementService { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Parameter] public EventCallback Display { get; set; }
    private ImageHelper ImageHelper = new();
    private string SelectedType = "weight";
    private AchievementFormModel formData = new();
    private string Today = DateOnly.FromDateTime(DateTime.Now).ToString("yyyy-MM-dd");

    private IBrowserFile? currentFile;
    private RenderFragment RenderFormFields()
    {
        RenderFragment fragment = @<div>
                <label for="description" class="fw-semibold">Ajout d'un commentaire :</label>
                <input @bind="formData.Description" type="text" id="description" name="description" class="form-control"
                    placeholder="Écrivez ici..." required />
        </div>;
    return SelectedType switch
{
"weight" => @<div>
@fragment
    <label class="fw-semibold mt-2">Poids (kg)</label>
    <input type="number" min="0" step="0.1" @bind="formData.Weight" class="form-control" required name="weight" />
</div>,

"measurement" => @<div>
@fragment
    <label class="fw-semibold mt-2">Tour de taille (cm)</label>
    <input type="number" @bind="formData.Hips" min="0" step="1" class="form-control" name="hips" required />

    <label class="fw-semibold mt-2">Tour de hanches (cm)</label>
    <input type="number" @bind="formData.Waist" min="0" step="1" class="form-control" name="waist" required />
</div>,

"photo" => @<div>
@fragment
    <label class="fw-semibold mt-2">Uploader une photo</label>
    <InputFile OnChange="HandlePhotoUpload" accept="image/" required />
</div>,

"free-comment" => @<div>
        <label class="fw-semibold mt-2">Commentaire</label>
        <textarea @bind="formData.Description" class="form-control" rows="3" placeholder="Écrire un commentaire"
            name="description" required></textarea>
    </div>,
    _ => @<div></div>
    };
}

private async Task HandleSubmit()
{
    var date = formData.DateAchieved;
    switch (SelectedType)
    {
        case "weight":
            await AchievementService.CreateWeightAchievementAsync(
            formData.Description!,
            formData.Weight!.Value,
            date
            );
            break;
        case "measurement":
            await AchievementService.CreateMeasurementAchievementAsync(
            formData.Description!,
            formData.Hips!.Value,
            formData.Waist!.Value,
            date
            );
            break;
        case "photo":
            {
                if (currentFile == null)
                {
                    Console.WriteLine("No file selected.");
                    return;
                }

                // Read the file as byte[]
                using var stream = currentFile.OpenReadStream(maxAllowedSize: 6_000_000); // 6MB
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);

                var imageBytes = ms.ToArray();

                // Assign to formData
                formData.Photo = imageBytes;

                if (formData.Photo == null || formData.Photo.Length == 0)
                {
                    Console.WriteLine("Photo is empty.");
                    return;
                }

                // Send to API (server will compress it)
                await AchievementService.CreatePhotoAchievementAsync(
                formData.Description!,
                formData.Photo,
                formData.DateAchieved
                );

                currentFile = null;
                break;
            }
        case "free-comment":
            await AchievementService.CreateFreeCommentAchievementAsync(
            formData.Description!,
            date
            );
            break;



    }
    await JS.InvokeVoidAsync("hideModal", "achievementModal");
    await Display.InvokeAsync();
}


private void HandlePhotoUpload(InputFileChangeEventArgs e)
{
    currentFile = e.File;
}

}